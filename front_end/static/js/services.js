// Generated by CoffeeScript 1.6.2
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module('episodeGet.services', []).service('userService', [
    '$rootScope', function($rootScope) {
      return {
        user: {
          id: 0,
          last_login: "",
          username: "游客",
          email: "",
          showUsername: function() {
            return this.username;
          }
        },
        updateUser: function(user) {
          this.user = user;
          return $rootScope.$broadcast('userService.update', this.user);
        }
      };
    }
  ]).service('infoListService', [
    '$rootScope', '$http', function($rootScope, $http) {
      return {
        list: {
          an: angular.fromJson(localStorage.getItem('infoList_an')),
          ep: angular.fromJson(localStorage.getItem('infoList_ep'))
        },
        getList: function(sort) {
          var _this = this;

          if (!this.list[sort]) {
            return $http({
              method: 'GET',
              url: '/info/.json',
              params: {
                nowplaying: 1,
                sort: sort
              }
            }).success(function(data) {
              localStorage.setItem('infoList_' + sort, angular.toJson(data.results));
              _this.list[sort] = data.results;
              return _this.updateList(sort, data.results);
            });
          }
        },
        updateList: function(sort, list) {
          this.list[sort] = list;
          return $rootScope.$broadcast('infoListService.update', this.list);
        },
        sortInfo: function(info) {
          return -info.douban.average;
        }
      };
    }
  ]).service('infoService', [
    '$rootScope', '$http', 'infoListService', function($rootScope, $http, infoListService) {
      return {
        getInfo: function(sort, id) {
          var bigInfoList, info, _i, _len,
            _this = this;

          bigInfoList = infoListService.list[sort];
          if (bigInfoList) {
            for (_i = 0, _len = bigInfoList.length; _i < _len; _i++) {
              info = bigInfoList[_i];
              if (info.id === parseInt(id, 10)) {
                return info;
                break;
              }
            }
          } else {
            return $http({
              method: 'GET',
              url: '/info/' + id + '/.json'
            }).success(function(data) {
              return data;
            });
          }
        }
      };
    }
  ]).service('tagsListService', [
    '$rootScope', '$http', function($rootScope, $http) {
      return {
        list: {
          an: angular.fromJson(localStorage.getItem('tagsList_an')),
          ep: angular.fromJson(localStorage.getItem('tagsList_ep'))
        },
        getList: function(sort) {
          var _this = this;

          if (!this.list[sort]) {
            return $http({
              method: 'GET',
              url: '/tags/.json',
              params: {
                sort: sort
              }
            }).success(function(data) {
              localStorage.setItem('tagsList_' + sort, angular.toJson(data.results));
              _this.list[sort] = data.results;
              return _this.updateList(sort, data.results);
            });
          }
        },
        updateList: function(sort, list) {
          this.list[sort] = list;
          return $rootScope.$broadcast('tagsListService.update', this.list);
        }
      };
    }
  ]).service('subListService', [
    '$rootScope', '$http', 'tagsListService', function($rootScope, $http, tagsListService) {
      return {
        subList: false,
        subListTags: {
          TM: [],
          CL: [],
          FM: [],
          LG: []
        },
        getList: function(sort, info) {
          var _this = this;

          return $http({
            method: 'GET',
            url: '/sub_list/.json',
            params: {
              info: info
            }
          }).success(function(data) {
            var subList, tag, tagId, tagsList, _i, _j, _k, _len, _len1, _len2, _ref, _ref1;

            _this.subList = data.results;
            tagsList = tagsListService.list[sort];
            _ref = _this.subList;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              subList = _ref[_i];
              _ref1 = subList.tags;
              for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
                tagId = _ref1[_j];
                tagId = parseInt(tagId, 10);
                if (__indexOf.call(_this.subListTags, tagId) < 0) {
                  for (_k = 0, _len2 = tagsList.length; _k < _len2; _k++) {
                    tag = tagsList[_k];
                    if (parseInt(tag.id, 10) === tagId) {
                      _this.subListTags[tag.style].push(tag);
                      break;
                    }
                  }
                }
              }
            }
            return $rootScope.$broadcast('subListService.update', _this.subList, _this.subListTags);
          });
        }
      };
    }
  ]);

}).call(this);
